<?xml version="1.0" encoding="UTF-8"?>
<services xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="http://moqui.org/xsd/service-definition-3.xsd">

    <!-- ====== Workorder Services ====== -->
    <service verb="create" noun="WorkOrder" type="inline">
        <in-parameters>
            <parameter name="customerId" required="true"/>
            <parameter name="vehicleId" required="true"/>
            <parameter name="estimateId"/>
            <parameter name="appointmentId"/>
            <parameter name="workOrderType" default-value="SHOP"/>
            <parameter name="priority" default-value="NORMAL"/>
            <parameter name="customerComplaint"/>
            <parameter name="mileageIn" type="Integer"/>
        </in-parameters>
        <out-parameters>
            <parameter name="workOrderId"/>
        </out-parameters>
        <actions>
            <service-call name="create#durion.workexec.DurWorkOrder" in-map="context" out-map="context"/>
            <set field="workOrderNumber" from="'WO-' + workOrderId"/>
            <service-call name="update#durion.workexec.DurWorkOrder" in-map="context"/>
        </actions>
    </service>

    <service verb="update" noun="WorkOrder" type="inline">
        <in-parameters>
            <parameter name="workOrderId" required="true"/>
            <parameter name="statusId"/>
            <parameter name="mechanicId"/>
            <parameter name="bayId"/>
            <parameter name="technicianNotes"/>
            <parameter name="mileageOut" type="Integer"/>
            <parameter name="actualCompletionDate" type="Timestamp"/>
        </in-parameters>
        <actions>
            <service-call name="update#durion.workexec.DurWorkOrder" in-map="context"/>
        </actions>
    </service>

    <service verb="add" noun="WorkOrderItem" type="inline">
        <in-parameters>
            <parameter name="workOrderId" required="true"/>
            <parameter name="itemType" required="true"/>
            <parameter name="productId"/>
            <parameter name="operationId"/>
            <parameter name="description" required="true"/>
            <parameter name="quantity" type="BigDecimal" default-value="1"/>
            <parameter name="unitPrice" type="BigDecimal" required="true"/>
            <parameter name="mechanicId"/>
            <parameter name="taxable" default-value="Y"/>
        </in-parameters>
        <out-parameters>
            <parameter name="workOrderItemId"/>
        </out-parameters>
        <actions>
            <entity-find-count entity-name="durion.workexec.DurWorkOrderItem" count-field="itemCount">
                <econdition field-name="workOrderId" from="workOrderId"/>
            </entity-find-count>
            <set field="itemSeqId" from="(itemCount + 1).toString().padLeft(3, '0')"/>
            <set field="lineTotal" from="quantity * unitPrice"/>
            <service-call name="create#durion.workexec.DurWorkOrderItem" in-map="context" out-map="context"/>
            <script>durion.workexec.DurWorkExecServices.calculateWorkOrderTotals(ec, workOrderId)</script>
        </actions>
    </service>

    <service verb="complete" noun="WorkOrder" type="inline">
        <in-parameters>
            <parameter name="workOrderId" required="true"/>
            <parameter name="mileageOut" type="Integer"/>
            <parameter name="technicianNotes"/>
        </in-parameters>
        <actions>
            <set field="statusId" value="WO_COMPLETED"/>
            <set field="actualCompletionDate" from="ec.user.nowTimestamp"/>
            <service-call name="update#durion.workexec.DurWorkOrder" in-map="context"/>
        </actions>
    </service>

    <!-- ====== Estimate Services ====== -->
    <service verb="create" noun="Estimate" type="inline">
        <in-parameters>
            <parameter name="customerId" required="true"/>
            <parameter name="vehicleId" required="true"/>
            <parameter name="description"/>
            <parameter name="expirationDays" type="Integer" default-value="30"/>
        </in-parameters>
        <out-parameters>
            <parameter name="estimateId"/>
        </out-parameters>
        <actions>
            <set field="expirationDate" from="ec.user.nowTimestamp + (expirationDays * 86400000L)"/>
            <service-call name="create#durion.workexec.DurEstimate" in-map="context" out-map="context"/>
            <set field="estimateNumber" from="'EST-' + estimateId"/>
            <service-call name="update#durion.workexec.DurEstimate" in-map="context"/>
        </actions>
    </service>

    <service verb="add" noun="EstimateItem" type="inline">
        <in-parameters>
            <parameter name="estimateId" required="true"/>
            <parameter name="itemType" required="true"/>
            <parameter name="productId"/>
            <parameter name="operationId"/>
            <parameter name="description" required="true"/>
            <parameter name="quantity" type="BigDecimal" default-value="1"/>
            <parameter name="unitPrice" type="BigDecimal" required="true"/>
            <parameter name="taxable" default-value="Y"/>
        </in-parameters>
        <out-parameters>
            <parameter name="estimateItemId"/>
        </out-parameters>
        <actions>
            <entity-find-count entity-name="durion.workexec.DurEstimateItem" count-field="itemCount">
                <econdition field-name="estimateId" from="estimateId"/>
            </entity-find-count>
            <set field="itemSeqId" from="(itemCount + 1).toString().padLeft(3, '0')"/>
            <set field="lineTotal" from="quantity * unitPrice"/>
            <service-call name="create#durion.workexec.DurEstimateItem" in-map="context" out-map="context"/>
            <script>durion.workexec.DurWorkExecServices.calculateEstimateTotals(ec, estimateId)</script>
        </actions>
    </service>

    <service verb="get" noun="CustomerBillingRules" type="script">
        <description>
            Lookup billing rules for a commercial account via the Customer (CRM facade).
            Used to determine if a PO number is required for estimate approval (CAP:092).

            Fail-safe behavior: if billing rules are unavailable (timeout/5xx/exception),
            this service returns purchaseOrderRequired=true and billingRulesAvailable=false.
        </description>
        <in-parameters>
            <parameter name="partyId" required="true"/>
        </in-parameters>
        <out-parameters>
            <parameter name="purchaseOrderRequired" type="Boolean"/>
            <parameter name="billingRulesAvailable" type="Boolean"/>
        </out-parameters>
        <actions>
            <script><![CDATA[
            import org.moqui.util.RestClient

            String configuredGatewayUrl = System.getProperty('pos.gateway.url',
                    System.getenv('POS_GATEWAY_URL') ?: 'http://localhost:8080')

            String gatewayUrl = configuredGatewayUrl
            while (gatewayUrl.endsWith('/')) gatewayUrl = gatewayUrl.substring(0, gatewayUrl.length() - 1)

            // Support deployments that (incorrectly) set POS_GATEWAY_URL to a service-prefixed path
            // such as http://host:8080/workorder by stripping known prefixes.
            List<String> knownServicePrefixes = [
                    'accounting', 'catalog', 'customer', 'inventory', 'invoice', 'inquiry', 'location',
                    'order', 'people', 'price', 'shop-manager', 'workorder', 'image', 'security-service',
                    'event-receiver', 'vehicle-fitment', 'vehicle-inventory'
            ]
            for (String prefix : knownServicePrefixes) {
                if (gatewayUrl.endsWith('/' + prefix)) {
                    gatewayUrl = gatewayUrl.substring(0, gatewayUrl.length() - prefix.length() - 1)
                    break
                }
            }

            String customerBaseUrl = gatewayUrl + '/customer'
            String jwtToken = ec.user.getLoginToken()

            purchaseOrderRequired = true
            billingRulesAvailable = false

            try {
                RestClient restClient = ec.service.rest()
                        .method('GET')
                        .uri("${customerBaseUrl}/v1/crm/accounts/parties/${partyId}/billingRules")
                        .addHeader('Accept', 'application/json')
                        .addHeader('X-API-Version', '1')

                if (jwtToken) {
                    restClient.addHeader('Authorization', "Bearer ${jwtToken}")
                }

                RestClient.RestResponse response = restClient.call()

                if (response.statusCode == 200) {
                    Map responseBody = (Map) response.jsonObject()
                    Object value = responseBody?.purchaseOrderRequired
                    if (value == null && responseBody?.billingRules instanceof Map) {
                        value = ((Map) responseBody.billingRules).purchaseOrderRequired
                    }

                    // If response is successful but doesn't include the field, treat as unavailable.
                    if (value instanceof Boolean) {
                        purchaseOrderRequired = (Boolean) value
                        billingRulesAvailable = true
                    }
                }
            } catch (Exception e) {
                // Fail-safe already set: require PO if rules can't be fetched.
            }
        ]]>            </script>
        </actions>
    </service>

    <service verb="approve" noun="Estimate" type="script">
        <in-parameters>
            <parameter name="estimateId" required="true"/>
            <parameter name="approvedBy"/>
            <parameter name="purchaseOrderNumber"/>
            <parameter name="idempotencyKey"/>
        </in-parameters>
        <actions>
            <script><![CDATA[
            import org.moqui.util.RestClient
            import java.util.UUID

            // Load estimate
            def estimate = ec.entity.find('durion.workexec.DurEstimate')
                    .condition('estimateId', estimateId)
                    .one()

            if (!estimate) {
                ec.message.addError('Estimate not found')
                return
            }

            if (!(estimate.statusId in ['EST_DRAFT', 'EST_SENT'])) {
                ec.message.addError('Estimate cannot be approved from its current status')
                return
            }

            String normalizedPoNumber = purchaseOrderNumber?.toString()?.trim()

            // Determine whether PO is required for this customer
            Map billingRules = ec.service.sync().name('durion.workexec.get#CustomerBillingRules')
                    .parameters([partyId: estimate.customerId])
                    .call() as Map

            boolean poRequired = (billingRules.purchaseOrderRequired == true)
            boolean rulesAvailable = (billingRules.billingRulesAvailable == true)

            // If rules are unavailable, fail-safe by requiring PO.
            if (!rulesAvailable) {
                poRequired = true
            }

            if (poRequired) {
                if (!normalizedPoNumber) {
                    ec.message.addError(rulesAvailable
                            ? 'Purchase order number is required to approve this estimate.'
                            : 'Billing rules are unavailable; purchase order number is required to approve this estimate.')
                    return
                }

                if (normalizedPoNumber.length() < 3 || normalizedPoNumber.length() > 64) {
                    ec.message.addError('Purchase order number must be between 3 and 64 characters.')
                    return
                }

                if (!(normalizedPoNumber ==~ /^[A-Za-z0-9][A-Za-z0-9._-]*$/)) {
                    ec.message.addError('Purchase order number contains invalid characters.')
                    return
                }
            }

            String configuredGatewayUrl = System.getProperty('pos.gateway.url',
                    System.getenv('POS_GATEWAY_URL') ?: 'http://localhost:8080')

            String gatewayUrl = configuredGatewayUrl
            while (gatewayUrl.endsWith('/')) gatewayUrl = gatewayUrl.substring(0, gatewayUrl.length() - 1)

            List<String> knownServicePrefixes = [
                    'accounting', 'catalog', 'customer', 'inventory', 'invoice', 'inquiry', 'location',
                    'order', 'people', 'price', 'shop-manager', 'workorder', 'image', 'security-service',
                    'event-receiver', 'vehicle-fitment', 'vehicle-inventory'
            ]
            for (String prefix : knownServicePrefixes) {
                if (gatewayUrl.endsWith('/' + prefix)) {
                    gatewayUrl = gatewayUrl.substring(0, gatewayUrl.length() - prefix.length() - 1)
                    break
                }
            }

            String workorderBaseUrl = gatewayUrl + '/workorder'
            String jwtToken = ec.user.getLoginToken()
            String requestIdempotencyKey = (idempotencyKey ?: UUID.randomUUID().toString())

            Map requestBody = [customerId: estimate.customerId]
            if (normalizedPoNumber) {
                requestBody.purchaseOrderNumber = normalizedPoNumber
            }

            RestClient restClient = ec.service.rest()
                    .method('POST')
                    .uri("${workorderBaseUrl}/v1/workorders/estimates/${estimateId}/approval")
                    .addHeader('Content-Type', 'application/json')
                    .addHeader('Accept', 'application/json')
                    .addHeader('X-API-Version', '1')
                    .addHeader('Idempotency-Key', requestIdempotencyKey)
                    .jsonObject(requestBody)

            if (jwtToken) {
                restClient.addHeader('Authorization', "Bearer ${jwtToken}")
            }

            RestClient.RestResponse response = restClient.call()

            if (response.statusCode == 200) {
                Map updateParams = [
                    estimateId: estimateId,
                    statusId: 'EST_APPROVED',
                    approvedDate: ec.user.nowTimestamp,
                    approvedBy: (approvedBy ?: ec.user.userId)
                ]
                if (normalizedPoNumber) {
                    updateParams.purchaseOrderNumber = normalizedPoNumber
                }

                ec.service.sync().name('update#durion.workexec.DurEstimate')
                    .parameters(updateParams)
                    .call()
            } else {
                String errorMsg = "Failed to approve estimate: ${response.statusCode} ${response.reasonPhrase}"
                try {
                    Map errorBody = response.jsonObject() as Map
                    if (errorBody?.message) errorMsg = errorBody.message
                } catch (Exception ignored) {
                    // Ignore parse failures
                }

                ec.message.addError(errorMsg)
                return
            }
        ]]>            </script>
        </actions>
    </service>

    <service verb="convert" noun="EstimateToWorkOrder" type="inline">
        <in-parameters>
            <parameter name="estimateId" required="true"/>
        </in-parameters>
        <out-parameters>
            <parameter name="workOrderId"/>
        </out-parameters>
        <actions>
            <entity-find-one entity-name="durion.workexec.DurEstimate" value-field="estimate"/>
            <service-call name="durion.workexec.create#WorkOrder" in-map="[customerId: estimate.customerId, vehicleId: estimate.vehicleId, estimateId: estimateId]" out-map="context"/>
            <entity-find entity-name="durion.workexec.DurEstimateItem" list="estimateItems">
                <econdition field-name="estimateId" from="estimateId"/>
            </entity-find>
            <iterate list="estimateItems" entry="item">
                <service-call name="durion.workexec.add#WorkOrderItem" in-map="[workOrderId: workOrderId, itemType: item.itemType, productId: item.productId, 
                             operationId: item.operationId, description: item.description, 
                             quantity: item.quantity, unitPrice: item.unitPrice, taxable: item.taxable]"/>
            </iterate>
            <set field="workOrderId" from="workOrderId"/>
            <service-call name="update#durion.workexec.DurEstimate" in-map="[estimateId: estimateId, workOrderId: workOrderId]"/>
        </actions>
    </service>

    <!-- ====== Invoice Services ====== -->
    <service verb="create" noun="InvoiceFromWorkOrder" type="inline">
        <in-parameters>
            <parameter name="workOrderId" required="true"/>
            <parameter name="paymentTerms" default-value="NET30"/>
        </in-parameters>
        <out-parameters>
            <parameter name="invoiceId"/>
        </out-parameters>
        <actions>
            <entity-find-one entity-name="durion.workexec.DurWorkOrder" value-field="workOrder"/>
            <set field="customerId" from="workOrder.customerId"/>
            <set field="subtotal" from="workOrder.totalLabor + workOrder.totalParts"/>
            <set field="taxAmount" from="workOrder.totalTax"/>
            <set field="totalAmount" from="workOrder.totalAmount"/>
            <set field="dueDate" from="ec.user.nowTimestamp + (30 * 86400000L)"/>
            <service-call name="create#durion.workexec.DurInvoice" in-map="context" out-map="context"/>
            <set field="invoiceNumber" from="'INV-' + invoiceId"/>
            <set field="balanceDue" from="totalAmount"/>
            <service-call name="update#durion.workexec.DurInvoice" in-map="context"/>
            <service-call name="update#durion.workexec.DurWorkOrder" in-map="[workOrderId: workOrderId, statusId: 'WO_INVOICED']"/>
        </actions>
    </service>

    <!-- ====== Warranty Services ====== -->
    <service verb="create" noun="WarrantyCase" type="inline">
        <in-parameters>
            <parameter name="customerId" required="true"/>
            <parameter name="vehicleId" required="true"/>
            <parameter name="workOrderId"/>
            <parameter name="originalWorkOrderId"/>
            <parameter name="warrantyType" required="true"/>
            <parameter name="warrantyProvider"/>
            <parameter name="description" required="true"/>
            <parameter name="failureDescription"/>
            <parameter name="claimAmount" type="BigDecimal"/>
        </in-parameters>
        <out-parameters>
            <parameter name="warrantyCaseId"/>
        </out-parameters>
        <actions>
            <service-call name="create#durion.workexec.DurWarrantyCase" in-map="context" out-map="context"/>
            <set field="caseNumber" from="'WC-' + warrantyCaseId"/>
            <service-call name="update#durion.workexec.DurWarrantyCase" in-map="context"/>
        </actions>
    </service>

    <service verb="update" noun="WarrantyCase" type="inline">
        <in-parameters>
            <parameter name="warrantyCaseId" required="true"/>
            <parameter name="statusId"/>
            <parameter name="approvedAmount" type="BigDecimal"/>
            <parameter name="denialReason"/>
            <parameter name="providerClaimNumber"/>
        </in-parameters>
        <actions>
            <service-call name="update#durion.workexec.DurWarrantyCase" in-map="context"/>
        </actions>
    </service>

    <!-- ====== Mobile Unit Services ====== -->
    <service verb="dispatch" noun="MobileUnit" type="inline">
        <in-parameters>
            <parameter name="mobileUnitId" required="true"/>
            <parameter name="workOrderId" required="true"/>
            <parameter name="mechanicId" required="true"/>
        </in-parameters>
        <actions>
            <set field="statusId" value="MU_DISPATCHED"/>
            <set field="currentMechanicId" from="mechanicId"/>
            <service-call name="update#durion.workexec.DurMobileUnit" in-map="context"/>
            <service-call name="update#durion.workexec.DurWorkOrder" in-map="[workOrderId: workOrderId, mobileUnitId: mobileUnitId, mechanicId: mechanicId, statusId: 'WO_IN_PROGRESS']"/>
        </actions>
    </service>

    <service verb="update" noun="MobileUnitLocation" type="inline">
        <in-parameters>
            <parameter name="mobileUnitId" required="true"/>
            <parameter name="currentLatitude" type="BigDecimal" required="true"/>
            <parameter name="currentLongitude" type="BigDecimal" required="true"/>
        </in-parameters>
        <actions>
            <set field="lastLocationUpdate" from="ec.user.nowTimestamp"/>
            <service-call name="update#durion.workexec.DurMobileUnit" in-map="context"/>
        </actions>
    </service>

    <!-- ====== Delivery Receipt Services ====== -->
    <service verb="create" noun="DeliveryReceipt" type="inline">
        <in-parameters>
            <parameter name="workOrderId" required="true"/>
            <parameter name="receiptType" required="true"/>
            <parameter name="receivedBy"/>
            <parameter name="deliveredBy"/>
            <parameter name="vehicleCondition"/>
            <parameter name="mileage" type="Integer"/>
            <parameter name="fuelLevel"/>
            <parameter name="customerSignature"/>
            <parameter name="notes"/>
        </in-parameters>
        <out-parameters>
            <parameter name="deliveryReceiptId"/>
        </out-parameters>
        <actions>
            <service-call name="create#durion.workexec.DurDeliveryReceipt" in-map="context" out-map="context"/>
            <set field="receiptNumber" from="'DR-' + deliveryReceiptId"/>
            <if condition="customerSignature">
                <set field="signatureDate" from="ec.user.nowTimestamp"/>
            </if>
            <service-call name="update#durion.workexec.DurDeliveryReceipt" in-map="context"/>
        </actions>
    </service>

</services>
