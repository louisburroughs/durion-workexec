<?xml version="1.0" encoding="UTF-8"?>
<screen xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:noNamespaceSchemaLocation="http://moqui.org/xsd/xml-screen-3.xsd"
        default-menu-title="Estimate" default-menu-index="2" require-authentication="true">

    <parameter name="estimateId" required="true"/>

    <transition name="updateEstimate">
        <service-call name="update#durion.workexec.DurEstimate"/>
        <default-response url="."/>
    </transition>

    <transition name="approveEstimate">
        <service-call name="durion.workexec.approve#Estimate"/>
        <default-response url="."/>
    </transition>

    <transition name="convertToWorkOrder">
        <service-call name="durion.workexec.convert#EstimateToWorkOrder"/>
        <default-response url="../WorkOrderEdit"><parameter name="workOrderId"/></default-response>
    </transition>

    <transition name="addEstimateItem">
        <service-call name="durion.workexec.add#EstimateItem"/>
        <default-response url="."/>
    </transition>

    <actions>
        <entity-find-one entity-name="durion.workexec.DurEstimate" value-field="estimate"/>
        <service-call name="durion.workexec.get#CustomerBillingRules" in-map="[partyId: estimate.customerId]" out-map="context"/>
        <entity-find entity-name="durion.workexec.DurEstimateItem" list="estimateItems">
            <econdition field-name="estimateId" from="estimateId"/>
            <order-by field-name="itemSeqId"/>
        </entity-find>
        <entity-find entity-name="durion.product.DurProduct" list="productList">
            <order-by field-name="productName"/>
        </entity-find>
        <entity-find entity-name="durion.product.DurServiceOperation" list="operationList">
            <order-by field-name="operationCode"/>
        </entity-find>
    </actions>

    <widgets>
        <container-row>
            <row-col lg="6">
                <form-single name="EstimateForm" map="estimate" transition="updateEstimate">
                    <field name="estimateId"><default-field><hidden/></default-field></field>
                    <field name="estimateNumber"><default-field><display/></default-field></field>
                    <field name="customerId"><default-field title="Customer"><display-entity entity-name="durion.crm.DurCustomer" text="${companyName}"/></default-field></field>
                    <field name="vehicleId"><default-field title="Vehicle"><display-entity entity-name="durion.crm.DurVehicle" text="${year} ${make} ${model}"/></default-field></field>
                    <field name="estimateDate"><default-field><display format="yyyy-MM-dd HH:mm"/></default-field></field>
                    <field name="expirationDate"><default-field><date-time type="date"/></default-field></field>
                    <field name="statusId"><default-field title="Status"><display/></default-field></field>
                    <field name="purchaseOrderNumber"><default-field title="PO Number"><display/></default-field></field>
                    <field name="description"><default-field><text-area rows="4"/></default-field></field>
                    <field name="totalAmount"><default-field><display format="#,##0.00"/></default-field></field>
                    <field name="notes"><default-field><text-area rows="3"/></default-field></field>
                    <field name="submitButton"><default-field title="Update"><submit/></default-field></field>
                </form-single>

                <container-box>
                    <box-header title="Actions"/>
                    <box-body>
                        <container>
                            <container condition="estimate.statusId == 'EST_DRAFT' || estimate.statusId == 'EST_SENT'">
                                <label text="Billing rules unavailable; PO number required (fail-safe)." type="warning"
                                       condition="billingRulesAvailable != true"/>
                                <label text="PO number required for this customer." type="warning"
                                       condition="billingRulesAvailable == true && purchaseOrderRequired == true"/>
                                <form-single name="ApproveEstimateForm" transition="approveEstimate">
                                    <field name="estimateId"><default-field><hidden default-value="${estimateId}"/></default-field></field>
                                    <field name="purchaseOrderNumber"><default-field title="PO Number"><text-line size="30" maxlength="64"/></default-field></field>
                                    <field name="submitButton"><default-field title="Approve Estimate"><submit/></default-field></field>
                                </form-single>
                            </container>
                                <link url="convertToWorkOrder" text="Convert to Workorder" condition="estimate.statusId == 'EST_APPROVED'"
                                  btn-type="primary" parameter-map="[estimateId: estimateId]"/>
                        </container>
                    </box-body>
                </container-box>
            </row-col>

            <row-col lg="6">
                <container-box>
                    <box-header title="Add Item"/>
                    <box-body>
                        <form-single name="AddItemForm" transition="addEstimateItem">
                            <field name="estimateId"><default-field><hidden default-value="${estimateId}"/></default-field></field>
                            <field name="itemType">
                                <default-field>
                                    <radio no-current-selected-key="PART">
                                        <option key="PART" text="Part"/>
                                        <option key="LABOR" text="Labor"/>
                                        <option key="SERVICE" text="Service"/>
                                        <option key="SUBLET" text="Sublet"/>
                                    </radio>
                                </default-field>
                            </field>
                            <field name="productId">
                                <default-field title="Product">
                                    <drop-down allow-empty="true">
                                        <list-options list="productList" key="${productId}" text="${productName} - ${sku}"/>
                                    </drop-down>
                                </default-field>
                            </field>
                            <field name="operationId">
                                <default-field title="Operation">
                                    <drop-down allow-empty="true">
                                        <list-options list="operationList" key="${operationId}" text="${operationCode} - ${operationName}"/>
                                    </drop-down>
                                </default-field>
                            </field>
                            <field name="description"><default-field><text-line size="50"/></default-field></field>
                            <field name="quantity"><default-field><text-line size="10" default-value="1"/></default-field></field>
                            <field name="unitPrice"><default-field title="Unit Price"><text-line size="15"/></default-field></field>
                            <field name="taxable">
                                <default-field><check><option key="Y" text="Taxable"/></check></default-field>
                            </field>
                            <field name="submitButton"><default-field title="Add Item"><submit/></default-field></field>
                        </form-single>
                    </box-body>
                </container-box>

                <form-list name="EstimateItemsList" list="estimateItems">
                    <field name="itemSeqId"><default-field title="Line"><display/></default-field></field>
                    <field name="itemType"><default-field title="Type"><display/></default-field></field>
                    <field name="description"><default-field><display/></default-field></field>
                    <field name="quantity"><default-field><display format="#,##0.00"/></default-field></field>
                    <field name="unitPrice"><default-field title="Price"><display format="#,##0.00"/></default-field></field>
                    <field name="lineTotal"><default-field title="Total"><display format="#,##0.00"/></default-field></field>
                </form-list>
            </row-col>
        </container-row>
    </widgets>
</screen>
