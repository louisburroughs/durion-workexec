<?xml version="1.0" encoding="UTF-8"?>
<screen xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:noNamespaceSchemaLocation="http://moqui.org/xsd/xml-screen-3.xsd"
        default-menu-title="Roadside Dispatch" default-menu-index="7">

    <transition name="dispatchUnit">
        <service-call name="durion.workexec.dispatch#MobileUnit"/>
        <default-response url="."/>
    </transition>

    <transition name="updateLocation">
        <service-call name="durion.workexec.update#MobileUnitLocation"/>
        <default-response url="."/>
    </transition>

    <transition name="createRoadsideWorkOrder">
        <service-call name="durion.workexec.create#WorkOrder" in-map="[workOrderType: 'ROADSIDE']"/>
        <default-response url="../WorkOrderEdit"><parameter name="workOrderId"/></default-response>
    </transition>

    <actions>
        <entity-find entity-name="durion.workexec.DurMobileUnit" list="mobileUnits">
            <order-by field-name="unitNumber"/>
        </entity-find>

        <entity-find entity-name="durion.workexec.DurWorkOrder" list="roadsideWorkOrders">
            <econdition field-name="workOrderType" value="ROADSIDE"/>
            <econditions combine="or">
                <econdition field-name="statusId" value="WO_CREATED"/>
                <econdition field-name="statusId" value="WO_SCHEDULED"/>
                <econdition field-name="statusId" value="WO_IN_PROGRESS"/>
            </econditions>
            <order-by field-name="priority"/>
            <order-by field-name="-orderDate"/>
        </entity-find>

        <entity-find entity-name="durion.shopmgr.DurShopMechanic" list="mechanics">
            <order-by field-name="lastName"/>
        </entity-find>
    </actions>

    <widgets>
        <container-row>
            <row-col lg="6">
                <container-box>
                    <box-header title="Mobile Units"/>
                    <box-body>
                        <form-list name="MobileUnitsList" list="mobileUnits" skip-form="true">
                            <field name="unitNumber">
                                <default-field title="Unit"><display/></default-field>
                            </field>
                            <field name="unitType">
                                <default-field title="Type"><display/></default-field>
                            </field>
                            <field name="currentMechanicId">
                                <default-field title="Mechanic">
                                    <display-entity entity-name="durion.shopmgr.DurShopMechanic" text="${firstName} ${lastName}"/>
                                </default-field>
                            </field>
                            <field name="statusId">
                                <default-field title="Status">
                                    <display also-hidden="false">
                                        <![CDATA[
                                        <span class="badge badge-${statusId == 'MU_AVAILABLE' ? 'success' : statusId == 'MU_ON_SCENE' ? 'primary' : 'warning'}">${statusId}</span>
                                        ]]>
                                    </display>
                                </default-field>
                            </field>
                            <field name="currentLatitude">
                                <default-field title="Location">
                                    <display text="${currentLatitude ?: 'N/A'}, ${currentLongitude ?: 'N/A'}"/>
                                </default-field>
                            </field>
                            <field name="lastLocationUpdate">
                                <default-field title="Last Update">
                                    <display format="HH:mm:ss"/>
                                </default-field>
                            </field>
                        </form-list>
                    </box-body>
                </container-box>

                <container-box>
                    <box-header title="Dispatch Mobile Unit"/>
                    <box-body>
                        <form-single name="DispatchForm" transition="dispatchUnit">
                            <field name="workOrderId">
                                <default-field title="Work Order">
                                    <drop-down allow-empty="false">
                                        <list-options list="roadsideWorkOrders" key="${workOrderId}" 
                                                     text="WO-${workOrderId} - ${ec.entity.find('durion.crm.DurCustomer').condition('customerId', customerId).one()?.companyName}"/>
                                    </drop-down>
                                </default-field>
                            </field>
                            <field name="mobileUnitId">
                                <default-field title="Mobile Unit">
                                    <drop-down allow-empty="false">
                                        <entity-options>
                                            <entity-find entity-name="durion.workexec.DurMobileUnit">
                                                <econdition field-name="statusId" value="MU_AVAILABLE"/>
                                            </entity-find>
                                        </entity-options>
                                        <list-options list="mobileUnits" key="${mobileUnitId}" text="${unitNumber} - ${unitType}"/>
                                    </drop-down>
                                </default-field>
                            </field>
                            <field name="mechanicId">
                                <default-field title="Mechanic">
                                    <drop-down allow-empty="false">
                                        <list-options list="mechanics" key="${mechanicId}" text="${firstName} ${lastName}"/>
                                    </drop-down>
                                </default-field>
                            </field>
                            <field name="submitButton">
                                <default-field title="Dispatch"><submit/></default-field>
                            </field>
                        </form-single>
                    </box-body>
                </container-box>
            </row-col>

            <row-col lg="6">
                <container-box>
                    <box-header title="Roadside Work Orders"/>
                    <box-toolbar>
                        <link url="createRoadsideWorkOrder" text="New Roadside Call" btn-type="danger"/>
                    </box-toolbar>
                    <box-body>
                        <form-list name="RoadsideWorkOrdersList" list="roadsideWorkOrders" skip-form="true">
                            <field name="workOrderNumber">
                                <default-field title="WO #">
                                    <link url="../WorkOrderEdit" text="${workOrderNumber}" link-type="anchor">
                                        <parameter name="workOrderId"/>
                                    </link>
                                </default-field>
                            </field>
                            <field name="customerId">
                                <default-field title="Customer">
                                    <display-entity entity-name="durion.crm.DurCustomer" text="${companyName}"/>
                                </default-field>
                            </field>
                            <field name="customerComplaint">
                                <default-field title="Issue">
                                    <display text="${customerComplaint ? customerComplaint.substring(0, Math.min(50, customerComplaint.length())) + '...' : 'N/A'}"/>
                                </default-field>
                            </field>
                            <field name="priority">
                                <default-field>
                                    <display also-hidden="false">
                                        <![CDATA[
                                        <span class="badge badge-${priority == 'URGENT' ? 'danger' : 'warning'}">${priority}</span>
                                        ]]>
                                    </display>
                                </default-field>
                            </field>
                            <field name="mobileUnitId">
                                <default-field title="Unit">
                                    <display-entity entity-name="durion.workexec.DurMobileUnit" text="${unitNumber}"/>
                                </default-field>
                            </field>
                            <field name="statusId">
                                <default-field title="Status"><display/></default-field>
                            </field>
                            <field name="orderDate">
                                <default-field title="Called">
                                    <display format="MM-dd HH:mm"/>
                                </default-field>
                            </field>
                        </form-list>
                    </box-body>
                </container-box>

                <container-box>
                    <box-header title="Map View"/>
                    <box-body>
                        <label text="[Interactive Map Placeholder - Shows mobile unit locations and roadside call locations]" 
                               style="text-align: center; padding: 40px; background-color: #e9ecef; border-radius: 5px;"/>
                    </box-body>
                </container-box>
            </row-col>
        </container-row>
    </widgets>
</screen>
